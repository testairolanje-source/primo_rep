<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gioco a Livelli ‚Äì Vinci il Premio!</title>
    <style>
        :root{
            --bg: #0f172a;
            --text: #e5e7eb;
            --soft: #9ca3af;
            --primary: #22c55e;
            --accent: #60a5fa;
            --danger: #ef4444;
            --radius: 18px;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background: radial-gradient(1200px 800px at 80% -10%, #1e293b 0, transparent 60%), radial-gradient(1000px 600px at -10% 110%, #111827 0, transparent 60%), var(--bg); color:var(--text);}
        .wrap{max-width:1100px; margin:0 auto; padding:24px}
        header{display:flex; align-items:center; gap:16px; justify-content:space-between; flex-wrap:wrap}
        .brand{display:flex; align-items:center; gap:12px}
        .logo{width:42px; height:42px; border-radius:14px; background:linear-gradient(135deg,var(--accent),var(--primary)); display:grid; place-items:center; color:#0b1020; font-weight:800; box-shadow:var(--shadow)}
        h1{font-size: clamp(22px, 3vw, 32px); margin:0}
        .progress{flex:1; min-width:240px; max-width:480px; height:12px; background: #0b1220; border-radius:999px; overflow:hidden; box-shadow:inset 0 0 0 1px #1b2640}
        .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--primary)); transition:width .4s ease}
        .card{background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); padding:20px}
        .grid{display:grid; gap:16px}
        @media(min-width:900px){ .grid{grid-template-columns: 1fr 1fr} }
        .levels{display:grid; gap:12px}
        .level{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 16px; border-radius:14px; background: #0b1220; border:1px solid rgba(255,255,255,.06)}
        .pill{padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.1)}
        .pill.lock{background:#1a243d}
        .pill.done{background:rgba(34,197,94,.2); color:#a7f3d0; border-color:rgba(34,197,94,.35)}
        .btn{appearance:none; border:none; background:linear-gradient(135deg, var(--accent), var(--primary)); color:#06111e; font-weight:700; padding:12px 16px; border-radius:12px; cursor:pointer; transition: transform .08s ease, filter .2s ease; box-shadow: var(--shadow)}
        .btn:active{transform:translateY(1px)}
        .btn[disabled]{opacity:.5; filter:grayscale(1); cursor:not-allowed}
        .game{margin-top:16px}
        .hidden{display:none !important}

        /* Reflex */
        .reflex{display:grid; place-items:center; height:280px; border-radius:14px; background:#091225; border:1px dashed rgba(255,255,255,.12); padding:18px; text-align:center}
        .reflex.ready{background:#1e293b}
        .reflex.go{background:#064e3b}
        .reflex h2{margin:0}

        /* Simon */
        .simon{width:min(420px, 96%); margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:10px}
        .pad{height:120px; border-radius:14px; opacity:.85; border:2px solid rgba(255,255,255,.12); cursor:pointer; transition: transform .06s ease, opacity .2s, filter .06s}
        .pad:active{transform:scale(.98)}
        /* aumentato contrasto quando attivo */
        .pad.active{opacity:1; filter:brightness(2.6) saturate(1.5); box-shadow:0 0 0 10px rgba(255,255,255,.12) inset}
        .p0{background:#b91c1c}
        .p1{background:#bdce05}
        .p2{background:#15803d}
        .p3{background:#1e40af}

        /* Memory pairs - 16 coppie */
        .pairs{display:grid; grid-template-columns: repeat(4, minmax(44px, 1fr)); gap:8px; max-width:960px; margin:0 auto}
        .tile{aspect-ratio:1/1; border-radius:12px; display:grid; place-items:center; background:#0b1220; border:1px solid rgba(255,255,255,.1); font-size:16px; cursor:pointer; user-select:none; transition: transform .08s ease}
        .tile.revealed{background:#13203a}
        .tile.matched{background:#064e3b}

        .quiz{display:grid; gap:10px; max-width:560px;color: var(--text)}
        .opt{padding:12px; border-radius:12px; background:#0b1220; border:1px solid rgba(255,255,255,.08); cursor:pointer;color: var(--text); }
        .opt.correct{outline:2px solid var(--primary)}
        .opt.wrong{outline:2px solid var(--danger)}

        .footer{margin-top:16px; color:var(--soft); font-size:12px}
        .prize{display:grid; place-items:center; gap:14px; text-align:center; padding:20px; background: #081426; border-radius:16px; border:1px solid rgba(255,255,255,.08)}
        .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; letter-spacing: 2px; font-weight:800; background:#0b1220; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1)}
        .toast{position:fixed; inset:auto 0 20px 0; display:grid; place-items:center; pointer-events:none}
        .toast .msg{pointer-events:auto; background:#0b1220; border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)}

        .diamond{width:12px; height:16px; transform:rotate(45deg); display:block}

        /* Mobile controls for Snake */
        .snake-controls {
            display: none;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-bottom: 20px; /* Aggiunge spazio sotto i pulsanti */
        }

        .snake-controls .btn {
            font-size: 1.5em;
            width: 120px;
        }

        @media (max-width: 600px) {
            .snake-controls {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div class="brand">
                <div class="logo">üéØ</div>
                <div>
                    <h1>Gioco a Livelli ‚Äì Vinci il Premio!</h1>
                    <div class="footer">Completa tutti i mini‚Äëgiochi per sbloccare il premio finale.</div>
                </div>
            </div>
            <div class="progress" aria-label="Progresso">
                <div class="bar" id="progressBar"></div>
            </div>
        </header>

        <main class="grid" style="margin-top:16px">
            <section class="card">
                <h2 style="margin-top:0">Livelli</h2>
                <div class="levels" id="levels"></div>
                <div class="footer">Il progresso √® salvato nel browser (localStorage). Puoi chiudere e tornare pi√π tardi.</div>
            </section>

            <section class="card">
                <h2 style="margin-top:0" id="gameTitle">Scegli un livello</h2>
                <div id="gameArea" class="game"></div>
            </section>
        </main>

        <section class="card hidden" id="prizeSection" style="margin-top:16px">
            <h2>üéâ Prova finale sbloccata!</h2>
            <div class="prize">
                <p>Congratulazioni, hai completato tutti i livelli!</p>
                <button class="btn" id="goToQuizBtn">Passa alla prova finale</button>
                <small class="footer">Preparati per l'ultima sfida!</small>
            </div>
        </section>
    </div>

    <div class="toast" id="toast" aria-live="polite" aria-atomic="true" role="status"></div>

    <audio id="clap-audio" src="https://cdn.pixabay.com/audio/2023/11/17/audio_c1e3458c89.mp3"></audio>
    <audio id="fail-audio" src="https://cdn.pixabay.com/audio/2023/07/07/audio_d1e8ce453e.mp3"></audio>

    <script>
        const state = {
            current: null,
            completed: JSON.parse(localStorage.getItem('completedLevels') || '[]'),
            prizeCode: localStorage.getItem('prizeCode') || null,
        };

        
        const LEVELS = [
            { id: 'snake', name: 'Livello 1 ¬∑ Snake Diamanti', desc: 'Mangia i diamanti fino a lunghezza 30.', icon: 'üêç', run: gameSnake },
            { id: 'simon', name: 'Livello 2 ¬∑ Simon Marathon', desc: 'Supera 7 sequenze (da 4 a 10 passi).', icon: 'üß†', run: gameSimon },
            { id: 'reflex', name: 'Livello 3 ¬∑ Reflex Rush', desc: 'Reagisci al segnale in meno di 400ms, 3 volte (max 10 tentativi).', icon: '‚ö°', run: gameReflex },
            { id: 'pairs', name: 'Livello 4 ¬∑ Memory', desc: 'Abbina tutte le coppie di oggetti preziosi (8 coppie).', icon: 'üíé', run: gamePairs },
            { id: 'lingo', name: 'Prova Finale ¬∑ Lingo', desc: 'Indovina 4 parole crescenti (5‚Üí8 lettere).', icon: 'üî§', run: gameLingo },
        ];


        function saveProgress(){ localStorage.setItem('completedLevels', JSON.stringify(state.completed)); }
        function showToast(text){
            const t = document.getElementById('toast');
            t.innerHTML = `<div class="msg">${text}</div>`;
            setTimeout(()=> t.innerHTML = '', 1600);
        }
        function updateProgressUI(){
            const bar = document.getElementById('progressBar');
            const pct = Math.round((state.completed.length / LEVELS.length) * 100);
            bar.style.width = pct + '%';
        }
        function playClap(){
            const audio = document.getElementById('clap-audio');
            audio.currentTime = 0;
            audio.play().catch(e => console.error("Audio playback failed:", e));
        }
        function playFail(){
            const audio = document.getElementById('fail-audio');
            audio.currentTime = 0;
            audio.play().catch(e => console.error("Audio playback failed:", e));
        }

        function renderLevels(){
            const container = document.getElementById('levels');
            container.innerHTML = '';
            LEVELS.forEach((lvl, idx) => {
                const isQuiz = lvl.id === 'quiz';
                const allPreviousCompleted = LEVELS.slice(0, LEVELS.length - 1).every(l => state.completed.includes(l.id));
                const locked = !isQuiz ? (idx > 0 && !state.completed.includes(LEVELS[idx-1].id)) : !allPreviousCompleted;
                const done = state.completed.includes(lvl.id);
                const row = document.createElement('div');
                row.className = 'level';
                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px">
                        <div style="font-size:22px">${lvl.icon}</div>
                        <div>
                            <div style="font-weight:700">${lvl.name}</div>
                            <small>${lvl.desc}</small>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px">
                        <span class="pill ${done ? 'done' : locked ? 'lock' : ''}">${done ? 'Completato' : locked ? 'Bloccato' : 'Pronto'}</span>
                        <button class="btn" ${locked ? 'disabled' : ''} aria-label="Gioca ${lvl.name}">Gioca</button>
                    </div>`;
                row.querySelector('button').onclick = () => startLevel(lvl);
                container.appendChild(row);
            });
        }

        function startLevel(lvl){
            if(lvl.id === 'quiz') {
                window.location.href = 'gratta.html';
                return;
            }
            state.current = lvl.id;
            document.getElementById('gameTitle').textContent = lvl.name;
            const area = document.getElementById('gameArea');
            area.innerHTML = '';
            lvl.run(area, onCompleteLevel);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function onCompleteLevel(id){
            if(!state.completed.includes(id)){
                state.completed.push(id); saveProgress(); updateProgressUI(); renderLevels();
                playClap();
                showToast('‚úÖ Livello completato!');
            }
            if(state.completed.length === LEVELS.length - 1){ unlockPrize(); }
        }

        function unlockPrize(){
            const sec = document.getElementById('prizeSection');
            sec.classList.remove('hidden');
            diamondRain(220);
        }

        function diamondRain(n=80){
            for(let i=0;i<n;i++){
                const s = document.createElement('div');
                s.className = 'diamond';
                s.style.position='fixed'; s.style.left=Math.random()*100+'vw'; s.style.top='-30px'; s.style.zIndex=9999;
                const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('width','14'); svg.setAttribute('height','18'); svg.setAttribute('viewBox','0 0 14 18');
                const path = document.createElementNS('http://www.w3.org/2000/svg','polygon');
                path.setAttribute('points','7,0 14,6 7,18 0,6');
                path.setAttribute('fill','var(--accent)');
                svg.appendChild(path);
                s.appendChild(svg);
                document.body.appendChild(s);
                const duration = 900 + Math.random()*1200;
                const translateX = (Math.random()*2-1)*120;
                s.animate([
                    { transform: `translate(0px,0px) rotate(${Math.random()*360}deg)`, opacity:1 },
                    { transform: `translate(${translateX}px, 110vh) rotate(${360+Math.random()*360}deg)`, opacity:0.9 }
                ], { duration, easing:'cubic-bezier(.2,.8,.2,1)' }).addEventListener('finish', ()=> s.remove());
            }
        }

        const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
        function playErrorTone(){ if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sawtooth'; o.frequency.value=220; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.01); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.25); setTimeout(()=>{ o.stop(); }, 300); }


        // ========================= GIOCHI =======================================
        function gameSnake(root, done){
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            canvas.style.backgroundColor = '#0b1220';
            canvas.style.borderRadius = '14px';
            canvas.style.border = '1px solid rgba(255,255,255,.12)';
            root.appendChild(canvas);

            const controls = document.createElement('div');
            controls.className = 'snake-controls';
            controls.innerHTML = `
                <button class="btn" id="snakeLeftBtn">‚¨ÖÔ∏è Gira a sinistra</button>
                <button class="btn" id="snakeRightBtn">‚û°Ô∏è Gira a destra</button>
            `;
            root.appendChild(controls);

            const ctx = canvas.getContext('2d');
            const gridSize = 20;
            const tileSize = canvas.width / gridSize;

            let snake = [{x: 10, y: 10}];
            let food = generateFood();
            let direction = {x: 1, y: 0};
            let targetLength = 30;

            function generateFood() {
                let newFood;
                do {
                    newFood = {
                        x: 1 + Math.floor(Math.random() * (gridSize - 2)),
                        y: 1 + Math.floor(Math.random() * (gridSize - 2))
                    };
                } while (snake.some(segment => segment.x === newFood.x && segment.y === newFood.y));
                return newFood;
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#0b1220';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#22c55e';
                snake.forEach(segment => {
                    ctx.fillRect(segment.x * tileSize, segment.y * tileSize, tileSize - 2, tileSize - 2);
                });

                ctx.fillStyle = '#60a5fa';
                ctx.font = `${tileSize * 0.8}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üíé', food.x * tileSize + tileSize / 2, food.y * tileSize + tileSize / 2);

                ctx.fillStyle = '#e5e7eb';
                ctx.font = '16px system-ui';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(`Lunghezza: ${snake.length}`, 10, 10);
            }

            function update() {
                const head = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};

                if (head.x < 0 || head.x >= gridSize || head.y < 0 || head.y >= gridSize) {
                    gameOver();
                    return;
                }

                for (let i = 1; i < snake.length; i++) {
                    if (head.x === snake[i].x && head.y === snake[i].y) {
                        gameOver();
                        return;
                    }
                }

                snake.unshift(head);

                if (head.x === food.x && head.y === food.y) {
                    showToast('üéâ Diamante raccolto! ' + (targetLength - snake.length) + ' rimasti.');
                    food = generateFood();
                } else {
                    snake.pop();
                }

                if (snake.length >= targetLength) {
                    clearInterval(gameLoop);
                    done('snake');
                    root.replaceChildren(successUI('Livello Snake completato!'));
                    return;
                }

                draw();
            }

            function gameOver() {
                clearInterval(gameLoop);
                playErrorTone();
                showToast('Game Over! Riprova.');
                root.innerHTML = '';
                gameSnake(root, done);
            }

            // Gestione input tastiera
            function handleKeyDown(e) {
                switch (e.key) {
                    case 'ArrowUp':
                        if (direction.y === 0) direction = {x: 0, y: -1};
                        break;
                    case 'ArrowDown':
                        if (direction.y === 0) direction = {x: 0, y: 1};
                        break;
                    case 'ArrowLeft':
                        if (direction.x === 0) direction = {x: -1, y: 0};
                        break;
                    case 'ArrowRight':
                        if (direction.x === 0) direction = {x: 1, y: 0};
                        break;
                }
            }
            document.addEventListener('keydown', handleKeyDown);

            // Gestione input touch (pulsanti separati)
            function handleTouchTurn(turnDir) {
                const { x, y } = direction;
                if (turnDir === 'left') {
                    if (x !== 0) direction = { x: 0, y: -x };
                    else direction = { x: y, y: 0 };
                } else if (turnDir === 'right') {
                    if (x !== 0) direction = { x: 0, y: x };
                    else direction = { x: -y, y: 0 };
                }
            }
            document.getElementById('snakeLeftBtn').onclick = () => handleTouchTurn('left');
            document.getElementById('snakeRightBtn').onclick = () => handleTouchTurn('right');

            const gameLoop = setInterval(update, 100);

            const observer = new MutationObserver(mutationsList => {
                for(const mutation of mutationsList) {
                    if (mutation.removedNodes.length > 0) {
                        for(const node of mutation.removedNodes) {
                            if (node === canvas || node === controls) {
                                clearInterval(gameLoop);
                                document.removeEventListener('keydown', handleKeyDown);
                            }
                        }
                    }
                }
            });
            observer.observe(root, { childList: true });
        }


        function gameReflex(root, done){
            let successCount = 0; let attempts = 0; let waiting=false; let timeoutId=null; let started=false;
            const targetMs = 400;

            const box = document.createElement('div'); box.className='reflex ready';
            const txt = document.createElement('div'); txt.innerHTML = `<h2>Quando lo sfondo diventa verde, clicca subito!</h2><div class="footer">Obiettivo: 3 reazioni &lt; ${targetMs}ms ‚Äî Hai ${10-attempts} tentativi rimasti</div>`;
            const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Avvia';
            const stats = document.createElement('div'); stats.className='footer';
            box.append(txt, btn, stats); root.appendChild(box);

            function updateFooter(){ txt.querySelector('.footer').textContent = `Obiettivo: 3 reazioni < ${targetMs}ms ‚Äî Hai ${10-attempts} tentativi rimasti`; }

            function schedule(){ waiting=true; box.classList.remove('go'); box.classList.add('ready'); const delay = 900 + Math.random()*1800; timeoutId = setTimeout(()=>{ box.classList.remove('ready'); box.classList.add('go'); waiting=false; started = performance.now(); }, delay); }

            btn.onclick = ()=>{ successCount=0; attempts=0; updateFooter(); stats.textContent=''; schedule(); btn.disabled=true; };

            box.onclick = ()=>{
                if(btn.disabled !== true) return;
                if(waiting){
                    clearTimeout(timeoutId); attempts++; playErrorTone(); stats.textContent = 'Troppo presto!'; updateFooter(); if(attempts>=10){ showToast('Hai esaurito i 10 tentativi ‚Äî ricomincio il livello'); root.innerHTML=''; return gameReflex(root, done); } schedule();
                } else if(started){
                    const t = Math.round(performance.now() - started);
                    stats.textContent = `Reazione: ${t}ms`;
                    if(t <= targetMs){ successCount++; showToast(`Ottimo! (${successCount}/3)`); diamondRain(80); }
                    else { attempts++; playErrorTone(); showToast('Troppo lento üòÖ'); updateFooter(); }
                    started=false;
                    if(successCount>=3){ done('reflex'); diamondRain(140); root.replaceChildren(successUI('Livello completato!')); }
                    else if(attempts>=10){ showToast('Hai esaurito i 10 tentativi ‚Äî ricomincio il livello'); root.innerHTML=''; return gameReflex(root, done); }
                    else schedule();
                }
            };
        }

        function gameSimon(root, done){
            let level = 0; // da 0 a 6 ‚Üí lunghezze 4..10
            let seq = [];
            let input = [];
            let playing = false;

            const wrap = document.createElement('div');
            const info = document.createElement('div'); info.className='footer';
            const grid = document.createElement('div'); grid.className='simon';
            const pads = [0,1,2,3].map(i=>{
                const d=document.createElement('div');
                d.className='pad p'+i;
                d.onclick=()=>press(i);
                grid.appendChild(d);
                return d;
            });
            const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Mostra Sequenza';
            wrap.append(btn, info, grid);
            root.appendChild(wrap);

            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const frequencies = [261.6, 329.6, 392.0, 523.3];

            function playTone(i,duration=0.3){
                const osc=audioCtx.createOscillator();
                const gain=audioCtx.createGain();
                osc.frequency.value=frequencies[i]; osc.connect(gain); gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.2,audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime+duration);
            }
            function playErrorTone(){ const osc=audioCtx.createOscillator(); osc.frequency.value=120; osc.type='sawtooth'; osc.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+0.4); }

            function flash(i){
                pads[i].classList.add('active');
                playTone(i);
                setTimeout(()=>pads[i].classList.remove('active'),450);
            }

            function startRound(){
                const length = 4 + level; // sequenza da 4..10
                seq = Array.from({length}, ()=> Math.floor(Math.random()*4));
                input = [];
                info.textContent=`Round ${level+1}/7: Osserva‚Ä¶`;
                btn.disabled=true;
                let t=0;
                seq.forEach((v,idx)=>setTimeout(()=>{
                    flash(v);
                    if(idx===seq.length-1) setTimeout(()=>{
                        playing=false; info.textContent='Tocca a te!';
                    },500);
                },t+=700));
            }

            function press(i){
                if(playing || btn.disabled!==true) return;
                playTone(i);
                input.push(i);
                const correctSoFar = input.every((v,k)=> v===seq[k]);
                if(!correctSoFar){
                    playErrorTone();
                    showToast('Errore! Ricominci dal primo round.');
                    level=0;
                    setTimeout(()=>{startRound();},800);
                    return;
                }
                if(input.length===seq.length){
                    level++;
                    if(level>=7){
                        diamondRain(140);
                        wrap.replaceChildren(successUI('Hai completato tutti i 7 round!'));
                        done('simon');
                    } else {
                        showToast(`‚úÖ Round ${level}/7 completato!`);
                        setTimeout(()=>{startRound();},1000);
                    }
                }
            }

            btn.onclick=startRound;
        }

        function gamePairs(root, done){
            const jewels = ['üíç','üìø','üìØ','üëë','üíé','üìå','üìè','üéÄ'];
            const items = shuffle(jewels.concat(jewels));
            const grid = document.createElement('div'); grid.className='pairs';
            let first=null, lock=false, matched=0, wrongs=0;

            items.forEach((e,idx)=>{
                const t = document.createElement('button'); t.className='tile'; t.textContent='?'; t.style.fontSize='13px'; t.setAttribute('aria-label','Carta coperta');
                t.onclick = ()=>{
                    if(lock || t.classList.contains('matched') || t===first) return;
                    reveal(t,e);
                    if(!first){ first=t; }
                    else{
                        lock=true;
                        if(first.dataset.v === e){ first.classList.add('matched'); t.classList.add('matched'); matched+=2; showToast('Coppia trovata!'); first=null; lock=false; if(matched===items.length){ root.replaceChildren(successUI('Tutte le coppie abbinate!')); done('pairs'); } }
                        else{ wrongs++; playErrorTone(); setTimeout(()=>{ hide(first); hide(t); first=null; lock=false; showToast(`Sbagli: ${wrongs}/5`); if(wrongs>=6){ showToast('Hai sbagliato 5 volte ‚Äî ricomincio il livello'); setTimeout(()=>{ root.innerHTML=''; return gamePairs(root, done); }, 400); } }, 700); }
                    }
                };
                hide(t); grid.appendChild(t);
            });

            root.appendChild(grid);

            function reveal(el, v){ el.textContent = v; el.dataset.v = v; el.classList.add('revealed'); el.setAttribute('aria-label','Carta '+v); }
            function hide(el){ el.textContent='?'; el.classList.remove('revealed'); }
            function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
        }

        function gameLingo(root, done) {
            const words = {
                5: ["cielo", "lisci", "sogno", "muro", "piano", "sassi", "amore", "cuore"],
                6: ["carato", "stella", "marina", "solare", "anello", "brillo", "fabbri"],
                7: ["viaggio", "cultura", "pensare", "amabile", "animale", "platino", "stupore"],
                8: ["prezioso", "fantasia", "diamante", "tramonto", "fratello", "capanna"]
            };

            let stage = 5; // Start with 5-letter words
            let currentWord = pickWord(stage);
            let attempts = 0;
            const maxAttempts = 6; // Increased to 6 attempts

            const gameContainer = document.createElement('div');
            gameContainer.style.display = 'flex';
            gameContainer.style.flexDirection = 'column';
            gameContainer.style.gap = '10px';
            gameContainer.style.maxWidth = '400px';
            gameContainer.style.margin = '0 auto';

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gap = '5px';

            const input = document.createElement('input');
            input.type = 'text';
            input.maxLength = stage;
            input.style.textTransform = 'uppercase';
            input.style.fontSize = '2em';
            input.style.padding = '8px';
            input.style.border = '1px solid #333';
            input.style.borderRadius = '8px';
            input.style.textAlign = 'center';
            input.style.background = '#0b1220';
            input.style.color = '#e5e7eb';
            input.style.letterSpacing = '5px';

            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = 'Invia';

            const info = document.createElement('div');
            info.className = 'footer';
            
            gameContainer.append(grid, input, btn, info);
            root.appendChild(gameContainer);

            function pickWord(len) {
                const arr = words[len];
                return arr[Math.floor(Math.random() * arr.length)];
            }

            function createGrid() {
                grid.innerHTML = '';
                grid.style.gridTemplateColumns = `repeat(${stage}, 1fr)`;
                for (let i = 0; i < maxAttempts * stage; i++) {
                    const tile = document.createElement('div');
                    tile.style.width = '100%';
                    tile.style.aspectRatio = '1 / 1';
                    tile.style.border = '2px solid #333';
                    tile.style.display = 'grid';
                    tile.style.placeItems = 'center';
                    tile.style.fontSize = '2em';
                    tile.style.fontWeight = 'bold';
                    tile.style.color = '#e5e7eb';
                    tile.style.borderRadius = '8px';
                    grid.appendChild(tile);
                }
                
                // Show the first letter of the word
                grid.children[0].textContent = currentWord[0].toUpperCase();
                grid.children[0].style.background = '#065f46';
                grid.children[0].style.border = '2px solid #065f46';
            }

            function updateGrid(guess) {
                const tiles = grid.children;
                const correctLetters = currentWord.split('');
                const guessLetters = guess.split('');
                const checkedLetters = new Array(stage).fill(false);
                
                // The first letter is always correct and already shown
                checkedLetters[0] = true;
                correctLetters[0] = null;
                
                // First pass: mark correct position letters (green)
                for (let i = 1; i < stage; i++) {
                    if (guessLetters[i] === correctLetters[i]) {
                        tiles[attempts * stage + i].style.background = '#065f46'; // Green
                        tiles[attempts * stage + i].style.border = '2px solid #065f46';
                        tiles[attempts * stage + i].textContent = guessLetters[i].toUpperCase();
                        checkedLetters[i] = true;
                        correctLetters[i] = null; // Mark as used
                    }
                }

                // Second pass: mark correct letters in wrong position (yellow)
                for (let i = 0; i < stage; i++) {
                    if (!checkedLetters[i]) {
                        const correctIndex = correctLetters.findIndex(letter => letter === guessLetters[i]);
                        if (correctIndex !== -1) {
                            tiles[attempts * stage + i].style.background = '#b45309'; // Yellow
                            tiles[attempts * stage + i].style.border = '2px solid #b45309';
                            tiles[attempts * stage + i].textContent = guessLetters[i].toUpperCase();
                            correctLetters[correctIndex] = null; // Mark as used
                        } else {
                            tiles[attempts * stage + i].style.background = '#333'; // Grey
                            tiles[attempts * stage + i].style.border = '2px solid #333';
                            tiles[attempts * stage + i].textContent = guessLetters[i].toUpperCase();
                        }
                    }
                }
            }

            function resetGame() {
                attempts = 0;
                stage = 5;
                currentWord = pickWord(stage);
                input.maxLength = stage;
                input.value = '';
                createGrid();
                info.textContent = `Indovina la parola di ${stage} lettere. Hai ${maxAttempts} tentativi.`;
            }

            function nextStage() {
                if (stage === 8) {
                    root.replaceChildren(successUI('Hai completato tutte le parole!'));
                    done('lingo');
                } else {
                    stage++;
                    currentWord = pickWord(stage);
                    attempts = 0;
                    input.maxLength = stage;
                    input.value = '';
                    createGrid();
                    info.textContent = `Bravo! Ora una parola di ${stage} lettere. Hai ${maxAttempts} tentativi.`;
                    diamondRain(80);
                }
            }

            btn.onclick = () => {
                const guess = input.value.toLowerCase().trim();
                if (guess.length !== stage) {
                    showToast(`La parola deve essere di ${stage} lettere.`);
                    return;
                }
                
                // The first letter of the guess must match the word's first letter
                if (guess[0] !== currentWord[0]) {
                    showToast(`La prima lettera deve essere "${currentWord[0].toUpperCase()}"`);
                    playErrorTone();
                    return;
                }

                attempts++;
                updateGrid(guess);

                if (guess === currentWord) {
                    playClap();
                    setTimeout(() => {
                        nextStage();
                    }, 1500);
                } else if (attempts >= maxAttempts) {
                    playErrorTone();
                    info.textContent = `Hai perso! La parola era "${currentWord.toUpperCase()}". Riprova.`;
                    input.disabled = true;
                    setTimeout(() => {
                        resetGame();
                        input.disabled = false;
                    }, 3000);
                } else {
                    info.textContent = `Sbagliato. Hai ${maxAttempts - attempts} tentativi rimasti.`;
                }
                input.value = '';
                input.focus();
            };
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    btn.click();
                }
            });

            resetGame();
        }


        function successUI(text){ const box=document.createElement('div'); box.style.display='grid'; box.style.placeItems='center'; box.style.gap='10px'; box.style.height='200px'; const h=document.createElement('div'); h.style.fontSize='18px'; h.style.fontWeight='800'; h.textContent=text; const b=document.createElement('div'); b.className='footer'; b.textContent='Puoi tornare alla lista livelli.'; box.append('‚úÖ', h, b); return box; }
        
        document.getElementById('prizeSection').addEventListener('click', (event) => {
            if (event.target && event.target.id === 'goToQuizBtn') {
                window.location.href = 'gratta.html';
            }
        });


        renderLevels(); updateProgressUI();
        const allLevelsCompleted = LEVELS.slice(0, LEVELS.length - 1).every(l => state.completed.includes(l.id));
        if(allLevelsCompleted) unlockPrize();
    </script>
</body>
</html>