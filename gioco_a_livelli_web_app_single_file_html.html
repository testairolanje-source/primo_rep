<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gioco a Livelli ‚Äì Vinci il Premio!</title>
  <style>
    :root{
      --bg: #0f172a;
      --text: #e5e7eb;
      --soft: #9ca3af;
      --primary: #22c55e;
      --accent: #60a5fa;
      --danger: #ef4444;
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background: radial-gradient(1200px 800px at 80% -10%, #1e293b 0, transparent 60%), radial-gradient(1000px 600px at -10% 110%, #111827 0, transparent 60%), var(--bg); color:var(--text);}    
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; gap:16px; justify-content:space-between; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:42px; height:42px; border-radius:14px; background:linear-gradient(135deg,var(--accent),var(--primary)); display:grid; place-items:center; color:#0b1020; font-weight:800; box-shadow:var(--shadow)}
    h1{font-size: clamp(22px, 3vw, 32px); margin:0}
    .progress{flex:1; min-width:240px; max-width:480px; height:12px; background: #0b1220; border-radius:999px; overflow:hidden; box-shadow:inset 0 0 0 1px #1b2640}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--primary)); transition:width .4s ease}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); padding:20px}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns: 1fr 1fr} }
    .levels{display:grid; gap:12px}
    .level{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 16px; border-radius:14px; background: #0b1220; border:1px solid rgba(255,255,255,.06)}
    .pill{padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.1)}
    .pill.lock{background:#1a243d}
    .pill.done{background:rgba(34,197,94,.2); color:#a7f3d0; border-color:rgba(34,197,94,.35)}
    .btn{appearance:none; border:none; background:linear-gradient(135deg, var(--accent), var(--primary)); color:#06111e; font-weight:700; padding:12px 16px; border-radius:12px; cursor:pointer; transition: transform .08s ease, filter .2s ease; box-shadow: var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5; filter:grayscale(1); cursor:not-allowed}
    .game{margin-top:16px}
    .hidden{display:none !important}

    /* Reflex */
    .reflex{display:grid; place-items:center; height:280px; border-radius:14px; background:#091225; border:1px dashed rgba(255,255,255,.12); padding:18px; text-align:center}
    .reflex.ready{background:#1e293b}
    .reflex.go{background:#064e3b}
    .reflex h2{margin:0}

    /* Simon */
    .simon{width:min(360px, 90%); margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .pad{height:120px; border-radius:14px; opacity:.85; border:2px solid rgba(255,255,255,.12); cursor:pointer; transition: transform .06s ease, opacity .2s, filter .06s}
    .pad:active{transform:scale(.98)}
    .pad.active{opacity:1; filter:brightness(1.7) saturate(1.2); box-shadow:0 0 0 6px rgba(255,255,255,.08) inset}
    .p0{background:#ef4444}
    .p1{background:#f59e0b}
    .p2{background:#22c55e}
    .p3{background:#3b82f6}

    /* Memory pairs */
    .pairs{display:grid; grid-template-columns: repeat(4, minmax(60px, 1fr)); gap:10px; max-width:420px; margin:0 auto}
    .tile{aspect-ratio:1/1; border-radius:12px; display:grid; place-items:center; background:#0b1220; border:1px solid rgba(255,255,255,.1); font-size:28px; cursor:pointer; user-select:none; transition: transform .08s ease}
    .tile.revealed{background:#13203a}
    .tile.matched{background:#064e3b}

    .quiz{display:grid; gap:10px; max-width:560px}
    .opt{padding:12px; border-radius:12px; background:#0b1220; border:1px solid rgba(255,255,255,.08); cursor:pointer}
    .opt.correct{outline:2px solid var(--primary)}
    .opt.wrong{outline:2px solid var(--danger)}

    .footer{margin-top:16px; color:var(--soft); font-size:12px}
    .prize{display:grid; place-items:center; gap:14px; text-align:center; padding:20px; background: #081426; border-radius:16px; border:1px solid rgba(255,255,255,.08)}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; letter-spacing: 2px; font-weight:800; background:#0b1220; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1)}
    .toast{position:fixed; inset:auto 0 20px 0; display:grid; place-items:center; pointer-events:none}
    .toast .msg{pointer-events:auto; background:#0b1220; border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)}

    .diamond{width:12px; height:16px; transform:rotate(45deg); display:block}

    /* Snake */
    .snake-board{background:#0b1220; border:2px solid #1f2937; width:300px; height:300px; display:grid; grid-template-columns: repeat(20, 1fr); grid-template-rows: repeat(20, 1fr); margin:0 auto;}
    .snake-cell{width:100%; height:100%;}
    .snake-body{background:#22c55e; border-radius:3px;}
    .snake-head{background:#16a34a; border-radius:4px;}
    .snake-food{display:flex; align-items:center; justify-content:center; font-size:16px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üéØ</div>
        <div>
          <h1>Gioco a Livelli ‚Äì Vinci il Premio!</h1>
          <div class="footer">Completa tutti i mini‚Äëgiochi per sbloccare il premio finale.</div>
        </div>
      </div>
      <div class="progress" aria-label="Progresso">
        <div class="bar" id="progressBar"></div>
      </div>
    </header>

    <main class="grid" style="margin-top:16px">
      <section class="card">
        <h2 style="margin-top:0">Livelli</h2>
        <div class="levels" id="levels"></div>
        <div class="footer">Il progresso √® salvato nel browser (localStorage). Puoi chiudere e tornare pi√π tardi.</div>
      </section>

      <section class="card">
        <h2 style="margin-top:0" id="gameTitle">Scegli un livello</h2>
        <div id="gameArea" class="game"></div>
      </section>
    </main>

    <section class="card hidden" id="prizeSection" style="margin-top:16px">
      <h2>üéâ Premio sbloccato!</h2>
      <div class="prize">
        <p>Congratulazioni! Hai completato tutti i livelli. Ecco il tuo codice premio:</p>
        <div class="code" id="prizeCode" aria-live="polite"></div>
        <button class="btn" id="copyCodeBtn">Copia Codice</button>
        <small class="footer">Suggerimento: Personalizza il testo del premio o collega un form per riscattarlo.</small>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true" role="status"></div>

  <script>
    const state = {
      current: null,
      completed: JSON.parse(localStorage.getItem('completedLevels') || '[]'),
      prizeCode: localStorage.getItem('prizeCode') || null,
    };

    const LEVELS = [
      { id: 'snake', name: 'Livello 1 ¬∑ Snake Diamanti', desc: 'Mangia i diamanti fino a lunghezza 30.', icon: 'üêç', run: gameSnake },
      { id: 'simon', name: 'Livello 2 ¬∑ Simon 5', desc: 'Ripeti la sequenza di 5 lampeggi.', icon: 'üß†', run: gameSimon },
      { id: 'pairs', name: 'Livello 3 ¬∑ Memory Gioielli', desc: 'Abbina tutte le coppie di oggetti preziosi.', icon: 'üíé', run: gamePairs },
      { id: 'reflex', name: 'Livello 4 ¬∑ Reflex Rush', desc: 'Reagisci al segnale in meno di 400ms, 3 volte (max 10 tentativi).', icon: '‚ö°', run: gameReflex },
      { id: 'quiz',  name: 'Livello 5 ¬∑ Quick Quiz', desc: 'Rispondi correttamente alle domande.', icon: '‚ùì', run: gameQuiz },
    ];

    function saveProgress(){ localStorage.setItem('completedLevels', JSON.stringify(state.completed)); }
    function showToast(text){
      const t = document.getElementById('toast');
      t.innerHTML = `<div class="msg">${text}</div>`;
      setTimeout(()=> t.innerHTML = '', 1600);
    }
    function updateProgressUI(){
      const bar = document.getElementById('progressBar');
      const pct = Math.round((state.completed.length / LEVELS.length) * 100);
      bar.style.width = pct + '%';
    }

    function renderLevels(){
      const container = document.getElementById('levels');
      container.innerHTML = '';
      LEVELS.forEach((lvl, idx) => {
        const locked = idx > 0 && !state.completed.includes(LEVELS[idx-1].id);
        const done = state.completed.includes(lvl.id);
        const row = document.createElement('div');
        row.className = 'level';
        row.innerHTML = `
          <div style="display:flex; align-items:center; gap:12px">
            <div style="font-size:22px">${lvl.icon}</div>
            <div>
              <div style="font-weight:700">${lvl.name}</div>
              <small>${lvl.desc}</small>
            </div>
          </div>
          <div style="display:flex; align-items:center; gap:8px">
            <span class="pill ${done ? 'done' : locked ? 'lock' : ''}">${done ? 'Completato' : locked ? 'Bloccato' : 'Pronto'}</span>
            <button class="btn" ${locked ? 'disabled' : ''} aria-label="Gioca ${lvl.name}">Gioca</button>
          </div>`;
        row.querySelector('button').onclick = () => startLevel(lvl);
        container.appendChild(row);
      });
    }

    function startLevel(lvl){
      state.current = lvl.id;
      document.getElementById('gameTitle').textContent = lvl.name;
      const area = document.getElementById('gameArea');
      area.innerHTML = '';
      lvl.run(area, onCompleteLevel);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function onCompleteLevel(id){
      if(!state.completed.includes(id)){
        state.completed.push(id); saveProgress(); updateProgressUI(); renderLevels();
        showToast('‚úÖ Livello completato!');
      }
      if(state.completed.length === LEVELS.length){ unlockPrize(); }
    }

    function unlockPrize(){
      const sec = document.getElementById('prizeSection');
      sec.classList.remove('hidden');
      if(!state.prizeCode){ state.prizeCode = genPrizeCode(); localStorage.setItem('prizeCode', state.prizeCode); }
      document.getElementById('prizeCode').textContent = state.prizeCode;
      diamondRain(220);
    }

    function genPrizeCode(){ const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let out = 'WIN-'; for(let i=0;i<8;i++) out += alphabet[Math.floor(Math.random()*alphabet.length)]; return out; }

    const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
    function playErrorTone(){ if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sawtooth'; o.frequency.value=220; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.01); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.25); setTimeout(()=>{ o.stop(); }, 300); }

    function diamondRain(n=80){
      for(let i=0;i<n;i++){
        const s = document.createElement('div');
        s.className = 'diamond';
        s.style.position='fixed'; s.style.left=Math.random()*100+'vw'; s.style.top='-30px'; s.style.zIndex=9999;
        const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('width','14'); svg.setAttribute('height','18'); svg.setAttribute('viewBox','0 0 14 18');
        const path = document.createElementNS('http://www.w3.org/2000/svg','polygon');
        path.setAttribute('points','7,0 14,6 7,18 0,6');
        const hue = Math.floor(Math.random()*360);
        path.setAttribute('fill',`hsl(${hue} 80% 60%)`);
        svg.appendChild(path);
        s.appendChild(svg);
        document.body.appendChild(s);
        const duration = 900 + Math.random()*1200;
        const translateX = (Math.random()*2-1)*120;
        s.animate([
          { transform: `translate(0px,0px) rotate(${Math.random()*360}deg)`, opacity:1 },
          { transform: `translate(${translateX}px, 110vh) rotate(${360+Math.random()*360}deg)`, opacity:0.9 }
        ], { duration, easing:'cubic-bezier(.2,.8,.2,1)' }).addEventListener('finish', ()=> s.remove());
      }
    }

    function gameSnake(root, done){
      const board = document.createElement('div');
